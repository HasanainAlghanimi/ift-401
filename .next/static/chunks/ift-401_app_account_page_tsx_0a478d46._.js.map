{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/hasan/ift-401/app/account/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { supabase } from \"@/lib/supabaseClient\";\r\n\r\ntype AccountState = {\r\n  accountId: number | null;\r\n  balance: number;\r\n  availableBalance: number;\r\n};\r\n\r\nexport default function AccountPage() {\r\n  const [loading, setLoading] = useState(true);\r\n  const [account, setAccount] = useState<AccountState>({\r\n    accountId: null,\r\n    balance: 0,\r\n    availableBalance: 0,\r\n  });\r\n  const [depositAmount, setDepositAmount] = useState(\"\");\r\n  const [withdrawAmount, setWithdrawAmount] = useState(\"\");\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [message, setMessage] = useState<string | null>(null);\r\n\r\n  // Load account for the current demo_session email\r\n  useEffect(() => {\r\n    const load = async () => {\r\n      try {\r\n        setError(null);\r\n        setMessage(null);\r\n\r\n        let email: string | null = null;\r\n        if (typeof window !== \"undefined\") {\r\n          try {\r\n            const raw = window.localStorage.getItem(\"demo_session\");\r\n            if (raw) {\r\n              const parsed = JSON.parse(raw);\r\n              email = parsed.email ?? null;\r\n            }\r\n          } catch {\r\n            email = null;\r\n          }\r\n        }\r\n\r\n        if (!email) {\r\n          setError(\"No session email found. Please sign in again.\");\r\n          return;\r\n        }\r\n\r\n        // users -> user_id\r\n        const { data: userRows, error: userError } = await supabase\r\n          .from(\"users\")\r\n          .select(\"user_id\")\r\n          .eq(\"email\", email)\r\n          .limit(1);\r\n\r\n        if (userError) {\r\n          console.error(\"user lookup error:\", userError);\r\n          setError(\"Could not load user record for this email.\");\r\n          return;\r\n        }\r\n        if (!userRows || userRows.length === 0) {\r\n          setError(\"No user record found for this email in the users table.\");\r\n          return;\r\n        }\r\n\r\n        const userId = userRows[0].user_id as number;\r\n\r\n        // account -> balances\r\n        const { data: accRows, error: accError } = await supabase\r\n          .from(\"account\")\r\n          .select(\"account_id, balance, available_balance\")\r\n          .eq(\"user_id\", userId)\r\n          .limit(1);\r\n\r\n        if (accError) {\r\n          console.error(\"account lookup error:\", accError);\r\n          setError(\"Could not load account for this user.\");\r\n          return;\r\n        }\r\n        if (!accRows || accRows.length === 0) {\r\n          setError(\r\n            \"No account row found for this user. Create one in Supabase (account.user_id = users.user_id).\"\r\n          );\r\n          return;\r\n        }\r\n\r\n        const row = accRows[0];\r\n\r\n        setAccount({\r\n          accountId: row.account_id,\r\n          balance: Number(row.balance) || 0,\r\n          availableBalance: Number(row.available_balance) || 0,\r\n        });\r\n      } catch (e: any) {\r\n        console.error(\"load account error:\", e);\r\n        setError(\"Failed to load account.\");\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    load();\r\n  }, []);\r\n\r\n  const handleDeposit = async () => {\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    const amt = Number(depositAmount);\r\n    if (!account.accountId) {\r\n      setError(\"No account loaded.\");\r\n      return;\r\n    }\r\n    if (!amt || amt <= 0) {\r\n      setError(\"Enter a positive deposit amount.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const newBalance = account.balance + amt;\r\n      const newAvailable = account.availableBalance + amt;\r\n\r\n      const { error: updateError } = await supabase\r\n        .from(\"account\")\r\n        .update({\r\n          balance: newBalance,\r\n          available_balance: newAvailable,\r\n        })\r\n        .eq(\"account_id\", account.accountId);\r\n\r\n      if (updateError) {\r\n        console.error(\"deposit update error:\", updateError);\r\n        setError(\"Deposit failed.\");\r\n        return;\r\n      }\r\n\r\n      setAccount((prev) => ({\r\n        ...prev,\r\n        balance: newBalance,\r\n        availableBalance: newAvailable,\r\n      }));\r\n      setDepositAmount(\"\");\r\n      setMessage(`Deposited $${amt.toFixed(2)} successfully.`);\r\n\r\n      // notify navbar\r\n      if (typeof window !== \"undefined\") {\r\n        window.dispatchEvent(\r\n          new CustomEvent(\"demo-balance-changed\", {\r\n            detail: { availableBalance: newAvailable },\r\n          })\r\n        );\r\n      }\r\n    } catch (e: any) {\r\n      console.error(\"deposit error:\", e);\r\n      setError(\"Deposit failed.\");\r\n    }\r\n  };\r\n\r\n  const handleWithdraw = async () => {\r\n    setError(null);\r\n    setMessage(null);\r\n\r\n    const amt = Number(withdrawAmount);\r\n    if (!account.accountId) {\r\n      setError(\"No account loaded.\");\r\n      return;\r\n    }\r\n    if (!amt || amt <= 0) {\r\n      setError(\"Enter a positive withdrawal amount.\");\r\n      return;\r\n    }\r\n    if (amt > account.availableBalance) {\r\n      setError(\"You cannot withdraw more than your available balance.\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const newBalance = account.balance - amt;\r\n      const newAvailable = account.availableBalance - amt;\r\n\r\n      const { error: updateError } = await supabase\r\n        .from(\"account\")\r\n        .update({\r\n          balance: newBalance,\r\n          available_balance: newAvailable,\r\n        })\r\n        .eq(\"account_id\", account.accountId);\r\n\r\n      if (updateError) {\r\n        console.error(\"withdraw update error:\", updateError);\r\n        setError(\"Withdrawal failed.\");\r\n        return;\r\n      }\r\n\r\n      setAccount((prev) => ({\r\n        ...prev,\r\n        balance: newBalance,\r\n        availableBalance: newAvailable,\r\n      }));\r\n      setWithdrawAmount(\"\");\r\n      setMessage(`Withdrew $${amt.toFixed(2)} successfully.`);\r\n\r\n      // notify navbar\r\n      if (typeof window !== \"undefined\") {\r\n        window.dispatchEvent(\r\n          new CustomEvent(\"demo-balance-changed\", {\r\n            detail: { availableBalance: newAvailable },\r\n          })\r\n        );\r\n      }\r\n    } catch (e: any) {\r\n      console.error(\"withdraw error:\", e);\r\n      setError(\"Withdrawal failed.\");\r\n    }\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <main\r\n        className=\"page accountpage container\"\r\n        style={{ paddingTop: 24, paddingBottom: 24 }}\r\n      >\r\n        <h1>Account</h1>\r\n        <p>Loading your accountâ€¦</p>\r\n      </main>\r\n    );\r\n  }\r\n\r\n  const buttonsDisabled = !account.accountId;\r\n\r\n  return (\r\n    <main\r\n      className=\"page accountpage container\"\r\n      style={{ paddingTop: 24, paddingBottom: 24, maxWidth: 900, margin: \"0 auto\" }}\r\n    >\r\n      <h1 className=\"accountpage__title\">Account</h1>\r\n      <p className=\"accountpage__subtitle\">\r\n        Manage your cash balance for trading (linked to your user record).\r\n      </p>\r\n\r\n      {error && (\r\n        <div className=\"account-alert account-alert--error\">\r\n          {error}\r\n        </div>\r\n      )}\r\n\r\n      {message && (\r\n        <div className=\"account-alert account-alert--ok\">\r\n          {message}\r\n        </div>\r\n      )}\r\n\r\n      <section className=\"account-grid\">\r\n        {/* Balances card */}\r\n        <div className=\"card accountcard\">\r\n          <h2>Balances</h2>\r\n          <p className=\"account-label\">Cash balance</p>\r\n          <p className=\"account-value\">\r\n            {`$${account.balance.toLocaleString(\"en-US\", {\r\n              minimumFractionDigits: 2,\r\n              maximumFractionDigits: 2,\r\n            })}`}\r\n          </p>\r\n\r\n          <p className=\"account-label\" style={{ marginTop: 12 }}>\r\n            Available to trade\r\n          </p>\r\n          <p className=\"account-value\">\r\n            {`$${account.availableBalance.toLocaleString(\"en-US\", {\r\n              minimumFractionDigits: 2,\r\n              maximumFractionDigits: 2,\r\n            })}`}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Deposit / Withdraw card */}\r\n        <div className=\"card accountcard accountcard--actions\">\r\n          <div>\r\n            <h2>Deposit</h2>\r\n            <div className=\"account-inputrow\">\r\n              <input\r\n                type=\"number\"\r\n                min=\"0\"\r\n                step=\"0.01\"\r\n                value={depositAmount}\r\n                onChange={(e) => setDepositAmount(e.target.value)}\r\n                placeholder=\"Amount\"\r\n                className=\"account-input\"\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleDeposit}\r\n                className=\"btn btn--primary\"\r\n                disabled={buttonsDisabled}\r\n              >\r\n                Deposit\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <h2>Withdraw</h2>\r\n            <div className=\"account-inputrow\">\r\n              <input\r\n                type=\"number\"\r\n                min=\"0\"\r\n                step=\"0.01\"\r\n                value={withdrawAmount}\r\n                onChange={(e) => setWithdrawAmount(e.target.value)}\r\n                placeholder=\"Amount\"\r\n                className=\"account-input\"\r\n              />\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleWithdraw}\r\n                className=\"btn btn--ghost\"\r\n                disabled={buttonsDisabled}\r\n              >\r\n                Withdraw\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n    </main>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}