{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/hasan/ift-401/app/portfolio/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useEffect, useMemo, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { supabase } from '@/lib/supabaseClient';\r\n\r\ntype PositionRow = {\r\n  position_id: number;\r\n  ticker_id: number;\r\n  quantity: number;\r\n  average_cost: number;   // <-- matches your table\r\n};\r\n\r\ntype UiRow = {\r\n  symbol: string;\r\n  qty: number;\r\n  pnl: number;\r\n};\r\n\r\nconst money = (n: number) =>\r\n  `$${n.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;\r\n\r\n// helper: get current account_id from demo_session -> users -> account\r\nasync function resolveAccountId(): Promise<number | null> {\r\n  try {\r\n    const raw = localStorage.getItem('demo_session');\r\n    if (!raw) return null;\r\n\r\n    const obj = JSON.parse(raw);\r\n    const email =\r\n      typeof obj?.email === 'string'\r\n        ? obj.email\r\n        : null;\r\n\r\n    if (!email) return null;\r\n\r\n    // 1) user_id from users by email\r\n    const { data: userRow, error: userErr } = await supabase\r\n      .from('users')\r\n      .select('user_id')\r\n      .eq('email', email)\r\n      .maybeSingle();\r\n\r\n    if (userErr || !userRow) {\r\n      console.error('resolveAccountId: user lookup failed', userErr);\r\n      return null;\r\n    }\r\n\r\n    const userId = (userRow as any).user_id as number;\r\n\r\n    // 2) account_id from account by user_id\r\n    const { data: acctRow, error: acctErr } = await supabase\r\n      .from('account')\r\n      .select('account_id')\r\n      .eq('user_id', userId)\r\n      .maybeSingle();\r\n\r\n    if (acctErr || !acctRow) {\r\n      console.error('resolveAccountId: account lookup failed', acctErr);\r\n      return null;\r\n    }\r\n\r\n    return (acctRow as any).account_id as number;\r\n  } catch (err) {\r\n    console.error('resolveAccountId error', err);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport default function PortfolioSimplePage() {\r\n  const router = useRouter();\r\n\r\n  const [mounted, setMounted] = useState(false);\r\n  const [loading, setLoading] = useState(true);\r\n  const [loadError, setLoadError] = useState<string | null>(null);\r\n  const [rows, setRows] = useState<UiRow[]>([]);\r\n\r\n  useEffect(() => {\r\n    setMounted(true);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!mounted) return;\r\n\r\n    const init = async () => {\r\n      setLoading(true);\r\n      setLoadError(null);\r\n\r\n      const hasSession = !!localStorage.getItem('demo_session');\r\n      if (!hasSession) {\r\n        router.replace('/signin');\r\n        return;\r\n      }\r\n\r\n      const accountId = await resolveAccountId();\r\n      if (!accountId) {\r\n        console.error('Portfolio: could not determine trading account');\r\n        setRows([]);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // 1) load positions for this account (note average_cost)\r\n      const { data: posRows, error: posErr } = await supabase\r\n        .from('position')\r\n        .select('position_id, ticker_id, quantity, average_cost')\r\n        .eq('account_id', accountId);\r\n\r\n      if (posErr) {\r\n        console.error('load positions error', posErr);\r\n        setLoadError('Failed to load portfolio.');\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      const positions = (posRows ?? []) as PositionRow[];\r\n\r\n      if (positions.length === 0) {\r\n        setRows([]);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // unique ticker_ids\r\n      const tickerIds = Array.from(\r\n        new Set(positions.map((p) => p.ticker_id))\r\n      );\r\n\r\n      if (tickerIds.length === 0) {\r\n        setRows([]);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      // 2) get symbols for those tickers\r\n      const { data: tickerRows, error: tickerErr } = await supabase\r\n        .from('ticker')\r\n        .select('ticker_id, symbol')\r\n        .in('ticker_id', tickerIds);\r\n\r\n      if (tickerErr) {\r\n        console.error('load tickers error', tickerErr);\r\n        setLoadError('Failed to load ticker symbols.');\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      const tickerMap = new Map<number, string>();\r\n      (tickerRows ?? []).forEach((t: any) => {\r\n        tickerMap.set(t.ticker_id, t.symbol);\r\n      });\r\n\r\n      // 3) latest daily close for each ticker\r\n      const priceMap = new Map<number, number>();\r\n\r\n      await Promise.all(\r\n        tickerIds.map(async (tid) => {\r\n          const { data, error } = await supabase\r\n            .from('pricebar')\r\n            .select('close')\r\n            .eq('ticker_id', tid)\r\n            .eq('time_interval', 'daily')\r\n            .order('bar_date', { ascending: false })\r\n            .order('bar_time', { ascending: false })\r\n            .limit(1)\r\n            .maybeSingle();\r\n\r\n          if (!error && data && (data as any).close != null) {\r\n            priceMap.set(tid, Number((data as any).close));\r\n          }\r\n        })\r\n      );\r\n\r\n      const ui: UiRow[] = positions.map((p) => {\r\n        const symbol = tickerMap.get(p.ticker_id) ?? '—';\r\n        const mark = priceMap.get(p.ticker_id) ?? p.average_cost;\r\n        const pnl = (mark - p.average_cost) * p.quantity;  // <-- use average_cost\r\n        return {\r\n          symbol,\r\n          qty: p.quantity,\r\n          pnl,\r\n        };\r\n      });\r\n\r\n      setRows(ui);\r\n      setLoading(false);\r\n    };\r\n\r\n    void init();\r\n  }, [mounted, router]);\r\n\r\n  const totalPnL = useMemo(\r\n    () => rows.reduce((a, r) => a + r.pnl, 0),\r\n    [rows]\r\n  );\r\n\r\n  if (!mounted) return null;\r\n\r\n  return (\r\n    <main className=\"container\" style={{ paddingTop: 24, paddingBottom: 24 }}>\r\n      <div className=\"pageheader\">\r\n        <div>\r\n          <h1 className=\"stocks__title\">Portfolio</h1>\r\n          <p className=\"stocks__sub\">\r\n            Your current holdings &amp; unrealized P/L.\r\n          </p>\r\n        </div>\r\n        <div className=\"header-actions\">\r\n          <span className={`badge ${totalPnL >= 0 ? 'badge--ok' : ''}`}>\r\n            Total Unrealized P/L:&nbsp;\r\n            <strong className={totalPnL >= 0 ? 'num is-up' : 'num is-down'}>\r\n              {totalPnL >= 0 ? '+' : ''}\r\n              {totalPnL.toFixed(2)}\r\n            </strong>\r\n          </span>\r\n        </div>\r\n      </div>\r\n\r\n      {loading ? (\r\n        <p>Loading portfolio…</p>\r\n      ) : loadError ? (\r\n        <p className=\"trade__alert is-error\">{loadError}</p>\r\n      ) : (\r\n        <section className=\"card portfoliotable\">\r\n          <div className=\"portfoliotable__head\">\r\n            <div className=\"portfoliotable__h left\">Symbol</div>\r\n            <div className=\"portfoliotable__h center\">Qty</div>\r\n            <div className=\"portfoliotable__h center\">Unrealized P/L</div>\r\n            <div />\r\n          </div>\r\n\r\n          <ul className=\"portfoliotable__body\">\r\n            {rows.length === 0 ? (\r\n              <li className=\"portfoliotable__row\">\r\n                <div\r\n                  className=\"muted\"\r\n                  style={{\r\n                    padding: 12,\r\n                    gridColumn: '1 / -1',\r\n                    textAlign: 'center',\r\n                  }}\r\n                >\r\n                  No positions yet.\r\n                </div>\r\n              </li>\r\n            ) : (\r\n              rows.map((r) => (\r\n                <li key={r.symbol} className=\"portfoliotable__row\">\r\n                  <div className=\"portfoliotable__symbol\">{r.symbol}</div>\r\n                  <div className=\"portfoliotable__qty\">{r.qty}</div>\r\n                  <div\r\n                    className={`portfoliotable__pnl ${\r\n                      r.pnl >= 0 ? 'is-up' : 'is-down'\r\n                    }`}\r\n                  >\r\n                    {r.pnl >= 0 ? '+' : ''}\r\n                    {r.pnl.toFixed(2)}\r\n                  </div>\r\n                  <div className=\"row__actions\">\r\n                    <button\r\n                      className=\"iconbtn\"\r\n                      title=\"Trade\"\r\n                      onClick={() => router.push('/trade')}\r\n                    >\r\n                      +\r\n                    </button>\r\n                  </div>\r\n                </li>\r\n              ))\r\n            )}\r\n          </ul>\r\n        </section>\r\n      )}\r\n    </main>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}